# Программный модуль для сбора и анализа данных с IOT-датчиков



### Docs

Документацию по MQTT API можно найти по пути *docs\async.yaml*. 
Для визуализации можно воспользоваться [этим сервисом](https://studio.asyncapi.com/). Для этого необходимо перенести содержимое файла в окно редактора.

___

### Deploy

```
git clone https://github.com/Kuchezai/iot-dashboard.git
cd iot-dashboard
docker-compose up --build
```
Если нет реальных IOT-устройств, то можно запустить их эмуляцию через скрипты, расположенные в *iot_devices/*

- Переименуйте файл .env.example в .env.
- Укажите необходимые переменные окружения
  - chat_id — id аккаунта в телеграме 
  - api_key — ключ от телеграм-бота. Подробней в документации [Telegram Bot API](https://core.telegram.org/bots/api)

После того как докер-контейнеры сбилидились, необходимо:
- Переейти по адресу [http://localhost:3000/](http://localhost:3000/) для входа в Grafan'у. Логин и пароль для первого входа = ```admin```;
- В бургер-меню слева выбрать **Dashboards**;
- **Create Dashboard**;
- **Import dashboard**;
- В окно для ввода вставить JSON из файла *dashboard.json*: расположенному по пути *dependencies\grafana\dashboards\dashboard.json*;
- **Load**;
- **Import**.

После выполнения всех шагов должен открыться дэшборд с метриками.
___

### Протокол тестирования 
#### Зеленые сценарии
##### Отображение метрик
При отправке MQTT сообщения, которое соотвествет документации, в журнале сервиса должна появиться запись вида
```JSON
Received message: {"sensor_id":"coordinates_sensor_01","timestamp":"2024-03-25T08:32:25.1366158+03:00","data":{"latitude":59.902948257729136,"longitude":30.471206357077637}} from topic: test/coordinate
```
Спустя 15 секунд на соответствующем графики в Grafan'е должны отобразиться изменения. 
При этом:
- График топлива
  -  Если текущий уровень топлиова стал меньше 50, то график должен стать желтым
  - Если текущий уровень топлиова стал меньше 20, то график должен стать красным
- График движения
  - Если обнаружено движение, то блок должен быть красным. Если движение обнаружено в неразрешенное время, то в телеграм должно прийти уведомление
  - Если не обнаружено движение, то блок должен быть зеленым
- График давления
  - Если давление попадает в разрешенный диапазон, то график должен быть зеленым
  - Если давление не попадает в разрешенный диапазон, то график должен быть красным
#### Красные сценарии
##### Невалидные данные
В случае, если поступивший json невозможно распарсить (неправильный формат данных, неполные данные, неправильный тип), то в журнале должно отобразиться сообщение об ошибке. Сервис должен продолжить работать, а значения на графиках остаться неизменными 